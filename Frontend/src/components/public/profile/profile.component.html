<div class="max-w-3xl mx-auto px-4 py-8">
  @if (isLoading) {
  <div class="flex justify-center py-10">
    <p class="text-gray-500 text-sm">Зареждане на профила...</p>
  </div>
  } @else if (error) {
  <div
    class="bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg px-4 py-3 dark:bg-red-950/40 dark:border-red-500/40 dark:text-red-200">
    {{ error }}
  </div>
  } @else if (profile) {

  @if (!profile.emailConfirmed) {
  <div class="mb-4 rounded-xl border border-amber-400 bg-amber-50 px-4 py-3 text-sm text-amber-800
               dark:bg-amber-950/40 dark:border-amber-500/60 dark:text-amber-100">
    Имейлът ти все още не е потвърден. Провери пощата си и използвай линка
    за потвърждение. Докато не го направиш, част от функционалностите
    (поръчки, детайли за поръчки и др.) са ограничени.
  </div>
  }


  <div
    class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl shadow-sm p-6 space-y-6">

    <!-- Горна част -->
    <div class="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6">
      <!-- Аватар -->
      <div
        class="h-16 w-16 rounded-full bg-blue-600 text-white flex items-center justify-center text-2xl font-semibold mx-auto sm:mx-0">
        {{ avatarLetter }}
      </div>

      <div class="text-center sm:text-left flex-1">
        <h1 class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-gray-100">
          {{ displayName }}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 break-all">
          {{ profile.email }}
        </p>

        @if (profile.roles?.length) {
        <div class="mt-2 flex flex-wrap justify-center sm:justify-start gap-1.5">
          @for (role of profile.roles; track $index) {
          <span class="inline-flex items-center rounded-full border border-gray-200 dark:border-gray-700
                         px-2.5 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-200">
            {{ role }}
          </span>
          }
        </div>
        }
      </div>

      <!-- Бутони (desktop) -->
      <div class="hidden sm:flex flex-col gap-2">
        @if (!isEditing) {
        <button type="button" (click)="startEdit()" class="inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-xs font-medium
                     text-gray-700 hover:bg-gray-50 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-800">
          Редактирай профил
        </button>
        } @else {
        <button type="button" (click)="save()" [disabled]="isSaving" class="inline-flex items-center justify-center rounded-lg border border-blue-600 px-4 py-2 text-xs font-medium
                     text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-70 dark:border-blue-500">
          {{ isSaving ? 'Запазване...' : 'Запази промените' }}
        </button>

        <button type="button" (click)="cancelEdit()" [disabled]="isSaving" class="inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-xs font-medium
                     text-gray-700 hover:bg-gray-50 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-800">
          Отказ
        </button>
        }

        <button type="button" (click)="logout()" class="inline-flex items-center justify-center rounded-lg border border-red-500 px-4 py-2 text-xs font-medium
                   text-red-600 hover:bg-red-50 dark:text-red-400 dark:border-red-500 dark:hover:bg-red-950/40">
          Изход
        </button>
      </div>
    </div>

    <hr class="border-gray-200 dark:border-gray-800" />

    <div class="grid gap-6 md:grid-cols-2">
      <!-- Лява колона – инфо -->
      <div class="space-y-4 text-sm">
        <h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200">
          Основна информация
        </h2>

        <div class="space-y-3">
          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Имейл</span>
            <span class="font-medium text-gray-900 dark:text-gray-100 break-all">
              {{ profile.email }}
            </span>
          </div>

          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Име</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">
              {{ profile.firstName || '—' }}
            </span>
          </div>

          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Фамилия</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">
              {{ profile.lastName || '—' }}
            </span>
          </div>

          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Телефон</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">
              {{ profile.phoneNumber || '—' }}
            </span>
          </div>

          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Град</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">
              {{ profile.city || '—' }}
            </span>
          </div>

          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Адрес</span>
            <span class="font-medium text-gray-900 dark:text-gray-100 text-right break-words">
              {{ profile.address || '—' }}
            </span>
          </div>

          @if (profile.createdAt) {
          <div class="flex items-start justify-between">
            <span class="text-gray-500 dark:text-gray-400">Член от</span>
            <span class="font-medium text-gray-900 dark:text-gray-100">
              {{ profile.createdAt | date:'dd.MM.yyyy' }}
            </span>
          </div>
          }
        </div>


        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 p-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold">Двуфакторна автентикация</h2>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Статус: {{ profile.twoFactorEnabled ? 'Включена' : 'Изключена' }}
              </p>
            </div>

            @if (!profile.twoFactorEnabled) {
            <button class="rounded-lg bg-blue-600 px-3 py-2 text-sm text-white hover:bg-blue-700 disabled:opacity-60"
              [disabled]="is2faBusy || !profile.emailConfirmed" (click)="start2faSetup()">
              Настрой
            </button>
            } @else {
            <button class="rounded-lg bg-red-600 px-3 py-2 text-sm text-white hover:bg-red-700 disabled:opacity-60"
              [disabled]="is2faBusy" (click)="disable2fa()">
              Изключи
            </button>
            }
          </div>

          @if (twoFaError) {
          <div class="text-sm text-red-600 dark:text-red-400">{{ twoFaError }}</div>
          }

          @if (!profile.twoFactorEnabled && twoFaSetup) {
          <div class="space-y-2 text-sm">
            <div class="text-xs text-gray-500 dark:text-gray-400">
              Сканирай QR от приложението или въведи ключа ръчно.
            </div>


            <!-- <div class="rounded-lg border border-gray-200 dark:border-gray-800 p-3">
              <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Manual key</div>
              <div class="font-mono break-all">{{ twoFaSetup.sharedKey }}</div>

              <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                otpauth URI (ако ще правиш QR на фронта):
              </div>
              <div class="font-mono break-all text-xs">{{ twoFaSetup.authenticatorUri }}</div>
            </div> -->

            @if (qrDataUrl) {
            <div
              class="rounded-xl border border-gray-200 dark:border-gray-800 p-3 inline-flex items-center justify-center bg-white">
              <img [src]="qrDataUrl" alt="2FA QR code" class="h-[180px] w-[180px]" />
            </div>
            }


            <div class="flex flex-col sm:flex-row gap-2">
              <input class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none
                 focus:border-blue-500 focus:ring-1 focus:ring-blue-500
                 dark:border-gray-700 dark:bg-gray-950 dark:text-gray-100 dark:placeholder:text-gray-500"
                placeholder="Код (пример: 123456)" [(ngModel)]="twoFaCode" />
              <button
                class="rounded-lg bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700 disabled:opacity-60"
                [disabled]="is2faBusy || !twoFaCode.trim()" (click)="enable2fa()">
                Потвърди
              </button>
            </div>
          </div>
          }

          @if (recoveryCodes?.length) {
          <div class="rounded-lg border border-amber-300 bg-amber-50 p-3 text-sm text-amber-900
                dark:border-amber-500/50 dark:bg-amber-950/40 dark:text-amber-100">
            <div class="font-semibold mb-2">Recovery codes (запази ги!)</div>
            <ul class="list-disc pl-5 font-mono text-xs space-y-1">
              @for (c of recoveryCodes; track c) {
              <li>{{ c }}</li>
              }
            </ul>
          </div>
          }
        </div>

      </div>



      <!-- Дясна колона – редакция -->
      <div class="space-y-4 text-sm">
        <h2 class="text-sm font-semibold text-gray-800 dark:text-gray-200">
          Настройки на профила
        </h2>

        <div class="space-y-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">
              Собствено име
            </label>
            <input type="text" [(ngModel)]="editModel.firstName" name="firstName" [disabled]="!isEditing || isSaving"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm
                       bg-white text-gray-900
                       dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">
              Фамилия
            </label>
            <input type="text" [(ngModel)]="editModel.lastName" name="lastName" [disabled]="!isEditing || isSaving"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm
                       bg-white text-gray-900
                       dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">
              Телефон
            </label>
            <input type="text" [(ngModel)]="editModel.phoneNumber" name="phoneNumber"
              [disabled]="!isEditing || isSaving" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm
                       bg-white text-gray-900
                       dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">
              Град
            </label>
            <input type="text" [(ngModel)]="editModel.city" name="city" [disabled]="!isEditing || isSaving" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm
                       bg-white text-gray-900
                       dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">
              Адрес
            </label>
            <input type="text" [(ngModel)]="editModel.address" name="address" [disabled]="!isEditing || isSaving" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm
                       bg-white text-gray-900
                       dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
          </div>

          <!-- Бутони за мобилен изглед -->
          <div class="flex flex-col sm:hidden gap-2 pt-2">
            @if (!isEditing) {
            <button type="button" (click)="startEdit()"
              class="inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-xs font-medium
                         text-gray-700 hover:bg-gray-50 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-800">
              Редактирай профил
            </button>
            } @else {
            <button type="button" (click)="save()" [disabled]="isSaving" class="inline-flex items-center justify-center rounded-lg border border-blue-600 px-4 py-2 text-xs font-medium
                         text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-70 dark:border-blue-500">
              {{ isSaving ? 'Запазване...' : 'Запази промените' }}
            </button>

            <button type="button" (click)="cancelEdit()" [disabled]="isSaving"
              class="inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-xs font-medium
                         text-gray-700 hover:bg-gray-50 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-800">
              Отказ
            </button>
            }

            <button type="button" (click)="logout()" class="inline-flex items-center justify-center rounded-lg border border-red-500 px-4 py-2 text-xs font-medium
                       text-red-600 hover:bg-red-50 dark:text-red-400 dark:border-red-500 dark:hover:bg-red-950/40">
              Изход
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
  }
</div>